# 定价毛利率 vs 售价毛利率功能说明

## 📋 功能概述

已为成本分析系统添加**定价毛利率**和**售价毛利率**双维度分析，帮助您全面了解商品的盈利能力和促销影响。

## 🎯 两种毛利率的区别

### 1. 定价毛利率（Pricing Margin Rate）
- **定义**：`(原价 - 成本) / 原价 × 100%`
- **含义**：商品按原价销售时的毛利率，体现商品本身的盈利能力
- **用途**：评估商品定价策略是否合理，是否有足够的盈利空间

### 2. 售价毛利率（Selling Margin Rate）
- **定义**：`(实际售价 - 成本) / 实际售价 × 100%`
- **含义**：商品按实际折扣价销售时的毛利率，体现真实盈利情况
- **用途**：评估促销活动后的实际盈利能力

### 3. 毛利率损失（Margin Loss）
- **计算**：`定价毛利率 - 售价毛利率`
- **含义**：由于促销折扣导致的毛利率下降
- **用途**：评估促销策略的成本效益

## 📊 实际应用示例

### 案例1：正常折扣商品
```
商品：某品牌矿泉水 550ml
原价：¥3.00
售价：¥2.50 (折扣：16.7%)
成本：¥1.80

定价毛利率 = (3.00 - 1.80) / 3.00 = 40.0%  ✅ 定价策略健康
售价毛利率 = (2.50 - 1.80) / 2.50 = 28.0%  ✅ 促销后仍有盈利
毛利率损失 = 40.0% - 28.0% = 12.0%  💡 促销影响可控
```

### 案例2：过度折扣商品
```
商品：某品牌牛奶 250ml
原价：¥5.00
售价：¥3.00 (折扣：40.0%)
成本：¥2.80

定价毛利率 = (5.00 - 2.80) / 5.00 = 44.0%  ✅ 定价策略健康
售价毛利率 = (3.00 - 2.80) / 3.00 = 6.7%   ⚠️ 促销后毛利极低
毛利率损失 = 44.0% - 6.7% = 37.3%  🚨 促销力度过大
```

### 案例3：亏损销售商品
```
商品：农夫山泉 1.5L
原价：¥3.00
售价：¥0.99 (折扣：67.0%)
成本：¥2.16

定价毛利率 = (3.00 - 2.16) / 3.00 = 28.0%   ✅ 定价策略合理
售价毛利率 = (0.99 - 2.16) / 0.99 = -118.2% 🚨 严重亏损
毛利率损失 = 28.0% - (-118.2%) = 146.2%  💣 引流商品策略
```

## 📈 在Excel报告中的体现

### 成本分析汇总表
新增列：
- `美团一级分类售价毛利率`：各分类实际销售的平均毛利率
- `美团一级分类定价毛利率`：各分类按原价计算的平均毛利率
- 汇总行显示全店整体的两种毛利率对比

### 高毛利商品TOP50
新增列：
- `售价毛利率`：实际销售毛利率（筛选条件：≥30%）
- `定价毛利率`：按原价的毛利率
- `原价`：商品标价

### 低毛利预警商品（TOP100）
新增列：
- `售价毛利率`：实际销售毛利率（筛选条件：<10%）
- `定价毛利率`：按原价的毛利率
- `原价`：商品标价

### 美团一级分类详细指标
新增列：
- `美团一级分类售价毛利率`
- `美团一级分类定价毛利率`

## 🎨 Dashboard可视化展示

### 成本分析汇总洞察
- 🏆 最高售价毛利率分类
- ⚠️ 最低售价毛利率分类
- 🔄 定价毛利率 vs 售价毛利率对比（显示促销影响）
- 💰 毛利贡献TOP1分类

### 高毛利商品洞察
- 📊 高毛利商品数量统计
- ⭐ 平均售价毛利率
- 💡 平均定价毛利率（按原价）
- 🥇 毛利率第一商品

### 低毛利预警洞察
- ⚠️ 低毛利商品数量
- 📉 平均售价毛利率
- 💰 平均定价毛利率（可优化空间）
- 🚨 负毛利商品统计（亏损销售数量）
- 💡 优化建议：对比两种毛利率差异，调整促销策略或优化成本

## 🔧 使用指南

### 重新生成报告
1. 确保原始数据包含`原价`、`售价`、`cost`列
2. 运行 `untitled1.py` 生成新报告
3. 新报告将自动包含两种毛利率指标

### Dashboard查看
1. 启动Dashboard：`启动Dashboard.bat`
2. 导航到 "💰 成本&毛利分析" 面板
3. 查看三个表格及对应洞察

### 数据分析建议

#### 场景1：定价毛利率高，售价毛利率低
**问题**：促销力度过大  
**建议**：
- 适当减小折扣幅度
- 评估促销带来的销量提升是否能弥补毛利损失
- 考虑采用满减、赠品等方式替代直接折扣

#### 场景2：定价毛利率低，售价毛利率更低
**问题**：定价策略和成本控制都存在问题  
**建议**：
- 优先优化供应链，降低采购成本
- 重新评估市场定价，适当提高原价
- 考虑商品是否适合继续销售

#### 场景3：售价毛利率为负
**问题**：亏损销售  
**建议**：
- 确认是否为战略性引流商品
- 评估引流效果，计算总体收益
- 非引流商品应立即调整价格或下架

## 📝 修改记录

### untitled1.py
- 第509-542行：新增售价毛利率、定价毛利率计算
- 第845-879行：分类级别成本聚合，添加定价毛利、定价毛利率
- 第1062-1111行：成本分析汇总Sheet，添加原价销售额、定价毛利、两种毛利率
- 第1181-1204行：Excel格式化白名单，添加新百分比列

### dashboard_v2.py
- 第3471-3529行：成本汇总洞察，添加定价毛利率对比
- 第3531-3602行：高毛利洞察，区分两种毛利率
- 第3604-3650行：低毛利洞察，添加定价毛利率分析和优化建议

## ⚙️ 技术细节

### 数据处理
- 使用pandas vectorized操作确保高性能
- 避免除零错误（分母为0时返回0）
- 保留旧的`毛利率`列以兼容现有代码（指向`售价毛利率`）

### 百分比格式化
- Excel中自动格式化为百分比（0.0% - 100.0%）
- Dashboard中显示一位小数（如：45.3%）
- 负数使用红色警告色

### 浮点数精度
- 计算过程中保留完整精度
- 显示时四舍五入到两位小数

## 🎯 业务价值

1. **更清晰的盈利分析**：区分商品本身盈利能力和促销影响
2. **促销效果评估**：量化促销对毛利率的影响
3. **定价策略优化**：通过定价毛利率评估定价合理性
4. **成本控制方向**：识别定价和成本的优化空间
5. **数据驱动决策**：基于双维度数据制定促销和定价策略

---

**版本**: v1.0  
**更新日期**: 2025-10-30  
**作者**: O2O门店数据分析系统
