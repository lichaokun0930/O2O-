# 促销效能分析 - "平均折扣"说明文档

## 📊 数据来源

**Excel列**: 美团一级分类折扣（索引28，Excel中的AC列）

## 🔢 定义和计算

### 1. 在untitled1.py中的计算（源头）

```python
# 位置：untitled1.py 第822-823行
_ratio = (l1_analysis['售价销售额'] / l1_analysis['原价销售额']).replace([np.inf, -np.inf], 0).fillna(0)
l1_analysis['美团一级分类折扣'] = (_ratio * 10.0).clip(lower=0, upper=10)
```

**计算公式**：
```
美团一级分类折扣 = (售价销售额 / 原价销售额) × 10
```

**数值含义**：
- 结果是"折"的概念（0-10折）
- 10折 = 原价销售（售价=原价）
- 7.89折 = 售价是原价的78.9%
- 5折 = 半价
- 数值越小 = 折扣力度越大

### 2. 实际案例

以"个人洗护"分类为例：
```
售价销售额: ¥81,973.51
原价销售额: ¥103,854.48
折扣计算: (81973.51 / 103854.48) × 10 = 7.89折
含义: 该分类整体按原价的78.9%销售
```

### 3. 在Dashboard中的显示

气泡图的hover信息：
```
平均折扣力度: 7.9折
```

这个"平均折扣力度"就是该分类内所有商品**销售额加权的平均折扣**。

## ⚠️ 重要说明

### 不是简单平均

这个折扣**不是**每个SKU折扣的简单平均，而是：
- **销售额加权**的折扣
- 计算方式：总售价销售额 / 总原价销售额 × 10
- 销售额大的商品对折扣的影响更大

### 示例对比

假设分类内有2个商品：
- 商品A: 原价10元，售价8元（8折），销量100件
  - 原价销售额 = 1000元
  - 售价销售额 = 800元
  
- 商品B: 原价10元，售价5元（5折），销量10件
  - 原价销售额 = 100元
  - 售价销售额 = 50元

**错误算法（简单平均）**：
```
(8折 + 5折) / 2 = 6.5折
```

**正确算法（销售额加权）**：
```
总原价销售额 = 1000 + 100 = 1100元
总售价销售额 = 800 + 50 = 850元
平均折扣 = (850 / 1100) × 10 = 7.73折
```

因为商品A销售额更大，所以整体折扣更接近8折。

## 🐛 之前的Bug（已修复）

### Bug描述
Dashboard错误地读取了索引24（美团一级分类毛利贡献度）而不是索引28（美团一级分类折扣）

### 错误影响
- 毛利贡献度的值通常在0-1之间（如0.45 = 45%贡献度）
- 被当作"折扣"显示时会显示为"0.45折"（错误！）
- 实际应该显示"7.89折"

### 修复内容
```python
# 修复前（错误）
discount_level = pd.to_numeric(df.iloc[:, 24], errors='coerce')  # 索引24 = 毛利贡献度 ❌

# 修复后（正确）
discount_level = pd.to_numeric(df.iloc[:, 28], errors='coerce')  # 索引28 = 折扣 ✅
```

## 📈 业务解读

### 折扣范围说明

| 折扣值 | 含义 | 促销力度 |
|--------|------|----------|
| 9.5-10折 | 原价或微折扣 | 无/极低 |
| 8-9.5折 | 小幅优惠 | 低 |
| 7-8折 | 标准促销 | 中等 |
| 6-7折 | 大力度促销 | 高 |
| <6折 | 清仓/爆品 | 极高 |

### 实际数据示例（修复后）

```
个人洗护: 7.89折（标准促销）
乳品/冰品: 8.68折（小幅优惠）
休闲食品: 8.25折（小幅优惠）
其他酒类: 8.93折（小幅优惠）
```

## 🔄 验证方法

在Excel中手动验证：
1. 打开"美团一级分类详细指标" Sheet
2. 找到任意分类（如"个人洗护"）
3. 查看：
   - R列（原价销售额）
   - S列（售价销售额）
   - AC列（美团一级分类折扣）
4. 验证公式：AC列 = (S列 / R列) × 10

---

**修复时间**: 2025年10月29日
**修复版本**: Dashboard v2.1
