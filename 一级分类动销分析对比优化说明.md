# 一级分类动销分析对比优化说明

## 加权排序算法优化 (2025-12-15)

### 问题背景
原排序逻辑按纯动销率排序，存在小样本偏差问题：SKU数量少的分类可能因为样本小而动销率虚高。

### 解决方案
采用加权排序公式：
```
排序分 = 动销率 × log₁₀(SKU数量 + 1)
```

### 算法说明
- 使用对数函数 `log₁₀` 对SKU数量进行平滑处理
- 避免SKU数量差异过大导致权重失衡
- 平衡动销率和样本量，让排名更具参考价值

### 示例
| 分类 | 动销率 | SKU数 | 加权分 |
|------|--------|-------|--------|
| A类 | 90% | 5 | 90 × 0.78 = 70.2 |
| B类 | 60% | 100 | 60 × 2.0 = 120 |
| C类 | 80% | 20 | 80 × 1.32 = 105.6 |

排序结果：B类 > C类 > A类

### 代码位置
- `dashboard_v2.py` - `ComparisonChartBuilder.create_active_rate_mirror_chart()`

---

## 优化目标
优化一级分类动销分析对比中的第一个图表（动销率对比），解决以下问题：
1. **对比效果不清晰**：原有8个数据系列（4个堆叠柱+2条折线）过于复杂，柱子密集
2. **动销率数值错误**：显示上万的数值（如7550），实际应该是75.5%

## 问题诊断

### 问题1：看不出对比效果
- **原因**：使用双Y轴（堆叠柱状图+折线图），8个数据系列太复杂
  - 本店动销SKU（深蓝柱）
  - 本店滞销SKU（浅蓝柱）
  - 竞对动销SKU（深红柱）
  - 竞对滞销SKU（浅红柱）
  - 本店动销率（蓝色折线）
  - 竞对动销率（红色折线）
- **影响**：柱子密集，对比效果不明显

### 问题2：动销率显示上万
- **原因**：数据格式误判
  - Excel中动销率格式：75.5%（数值75.5，不是0.755）
  - 代码错误地乘以100：`y=own_data[active_rate_col] * 100`
  - 文本也乘以100：`text=[f"{v*100:.1f}%" for v in own_data[active_rate_col]]`
- **结果**：75.5 × 100 = 7550，显示为7550%

## 优化方案

### 方案概述
**双Y轴（柱状图+折线图交叉展示）**
- 左Y轴：去重SKU数（分组柱状图，不堆叠）
- 右Y轴：动销率0-100%（折线图穿过柱子）
- 数据系列：从8个减少到4个
- 智能标签定位：避免重叠
- 差异标注：自动高亮显著差异

### 详细设计

#### 1. 图表类型调整
```python
# 原方案：堆叠柱状图
barmode='stack'  # 8个系列堆叠

# 新方案：分组柱状图
barmode='group'  # 4个系列分组
```

#### 2. 数据系列优化（8个→4个）

**左Y轴 - 去重SKU数（2个柱状图）**
- 本店去重SKU数（蓝色柱，opacity=0.7）
- 竞对去重SKU数（红色柱，opacity=0.7）
- 动销/滞销详情移到Hover中显示

**右Y轴 - 动销率（2条折线）**
- 本店动销率（蓝色折线）
- 竞对动销率（红色折线）

#### 3. 动销率数据修复

**修复前（错误）**
```python
# Y轴数据
y=own_data[active_rate_col] * 100  # 75.5 × 100 = 7550

# 文本标签
text=[f"{v*100:.1f}%" for v in own_data[active_rate_col]]  # 7550.0%
```

**修复后（正确）**
```python
# Y轴数据 - 直接使用原始值
y=own_data[active_rate_col]  # 75.5

# 文本标签 - 不乘100
text=[f"{v:.1f}%" for v in own_data[active_rate_col]]  # 75.5%
```

#### 4. 智能标签定位

**目标**：避免标签重叠

**逻辑**：
```python
for i, category in enumerate(categories):
    own_rate = own_rates[i]
    comp_rate = comp_rates[i]
    
    # 高的标签在上，低的在下
    if own_rate > comp_rate:
        own_text_positions.append('top center')
        comp_text_positions.append('bottom center')
    else:
        own_text_positions.append('bottom center')
        comp_text_positions.append('top center')
```

#### 5. 差异标注

**规则**：
- 差距 > 15%：🔴 红色警告（红色背景）
- 差距 > 10%：⚠️ 黄色警告（黄色背景）
- 差距 ≤ 10%：无标注

**实现**：
```python
diff = abs(own_rate - comp_rate)

if diff > 15:
    # 红色警告
    annotations.append(dict(
        x=category,
        y=max(own_rate, comp_rate) + 5,
        text=f"🔴 差距{diff:.1f}%",
        bgcolor='rgba(231, 76, 60, 0.2)',
        bordercolor='#c0392b'
    ))
elif diff > 10:
    # 黄色警告
    annotations.append(dict(
        x=category,
        y=max(own_rate, comp_rate) + 5,
        text=f"⚠️ 差距{diff:.1f}%",
        bgcolor='rgba(243, 156, 18, 0.2)',
        bordercolor='#f39c12'
    ))
```

#### 6. 视觉优化

**柱子透明度**
```python
opacity=0.7  # 让折线更清晰可见
```

**Hover信息增强**
```python
hovertemplate=(
    '%{x}<br>'
    '去重SKU数: %{y}<br>'
    '动销SKU: %{customdata[0]}<br>'
    '滞销SKU: %{customdata[1]}<extra></extra>'
)
```

## 优化效果

### 对比效果提升
- ✅ 数据系列从8个减少到4个
- ✅ 柱子分组展示，不再堆叠
- ✅ 折线穿过柱子，对比清晰
- ✅ 柱子透明度0.7，折线更突出

### 动销率显示修复
- ✅ 75.5% 正确显示（不再是7550%）
- ✅ Y轴范围0-100%合理
- ✅ 数据标签格式正确

### 用户体验优化
- ✅ 智能标签定位，避免重叠
- ✅ 自动差异标注，快速识别问题分类
- ✅ Hover显示完整信息（动销/滞销详情）
- ✅ 保留所有原有数据，无信息丢失

## 技术要点

### 1. 数据格式处理
```python
# 关键：Excel中的百分比格式
# 75.5% 在Excel中存储为数值 75.5（不是0.755）
# 因此代码中不需要乘以100
```

### 2. 双Y轴配置
```python
# 左Y轴：SKU数量（整数）
fig.update_yaxes(
    title_text="去重SKU数",
    secondary_y=False
)

# 右Y轴：动销率（百分比）
fig.update_yaxes(
    title_text="动销率 (%)",
    secondary_y=True,
    range=[0, 100]
)
```

### 3. 智能标签定位
```python
# 使用列表推导式动态生成每个数据点的标签位置
textposition=own_text_positions  # ['top center', 'bottom center', ...]
```

### 4. 注释系统
```python
# 使用layout.annotations添加动态标注
fig.update_layout(
    annotations=annotations  # 差异标注列表
)
```

## 其他图表保持不变

### 图表2：SKU数量对比（镜像柱状图）
- 保持原有设计
- 展示未去重的SKU数量

### 图表3：销售额对比（分组柱状图）
- 保持原有设计
- 展示实际销售额数值（不使用K简写）

## 测试验证

### 验证点
1. ✅ 动销率显示为75.5%（不是7550%）
2. ✅ 柱状图分组展示（不堆叠）
3. ✅ 折线图穿过柱子
4. ✅ 标签无重叠
5. ✅ 差异标注正确显示
6. ✅ Hover信息完整

### 测试数据
```python
# 示例数据
一级分类: ['食品', '饮料', '日用品']
本店动销率: [75.5, 82.3, 68.9]  # 直接使用，不乘100
竞对动销率: [80.2, 78.5, 55.6]
差异: [4.7, 3.8, 13.3]  # 第三个分类会显示⚠️警告
```

## 文件修改

### 修改文件
- `dashboard_v2.py` (第920-1100行)

### 修改函数
- `ComparisonChartBuilder.create_active_rate_comparison_chart`

### 关键修改点
1. 将`barmode='stack'`改为`barmode='group'`
2. 删除4个堆叠柱系列，只保留2个分组柱系列
3. 去掉动销率的`* 100`乘法
4. 实现智能标签定位逻辑
5. 添加差异标注系统
6. 设置柱子透明度为0.7
7. 将动销/滞销详情移到Hover中

## 总结

本次优化成功解决了一级分类动销分析对比中的两个核心问题：
1. **对比效果不清晰** → 简化数据系列，优化视觉层次
2. **动销率数值错误** → 修复数据格式处理逻辑

同时增加了智能标签定位和差异标注功能，提升了用户体验和数据洞察能力。
