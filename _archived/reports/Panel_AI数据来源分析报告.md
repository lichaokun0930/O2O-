# Panel AI 数据来源与计算逻辑分析报告

## 🔍 你的核心问题

1. **Panel AI分析的是看板数据还是原始数据？**
2. **AI是否知道数据的计算逻辑？**
3. **AI取的数据和看板显示的是同一个数据源吗？**
4. **如果AI不知道计算逻辑，会有什么问题？**

---

## 📊 当前数据流分析

### 数据流程图

```
原始Excel数据
    ↓ (untitled1.py处理)
已处理的报告 (竞对分析报告_v3.4_FINAL.xlsx)
    ├─ Sheet: 核心指标对比 → loader.data['kpi']
    ├─ Sheet: 价格带分析 → loader.data['price_analysis']  
    ├─ Sheet: 美团一级分类详细指标 → loader.data['category_l1']
    └─ Sheet: 详细SKU报告 → loader.data['sku_details']
    ↓
Dashboard看板渲染 (直接使用这些数据)
    ↓
collect_dashboard_data() (提取这些数据)
    ↓
Panel AI分析器 (分析提取的数据)
```

### 关键发现

#### ✅ 好消息
1. **同一数据源**: Panel AI和看板使用**完全相同**的数据源
   - 来源: `loader.data['kpi']`, `loader.data['category_l1']`等
   - 看板直接渲染这些数据
   - Panel AI通过`collect_dashboard_data()`提取这些数据

2. **已处理数据**: 传递给AI的是**已经计算好的指标**，而不是原始数据
   - KPI: `'总SKU数(含规格)'`, `'动销率'`, `'滞销SKU数'`等都是计算好的
   - Category: `'售价销售额'`, `'美团一级分类动销率(类内)'`等都是计算好的

#### ❌ 潜在问题

**AI并不知道这些指标的计算逻辑！**

---

## ⚠️ 问题详解

### 问题1: AI不知道"动销率"是怎么算的

**当前情况**:
```python
# collect_dashboard_data提取的数据
kpi_data = {
    '总SKU数(含规格)': 8527,
    '动销SKU数': 3250,
    '动销率': 45.52,  # ← AI只看到这个数字
    '滞销SKU数': 5277,
    ...
}
```

**AI看到的**:
- 只看到"动销率: 45.52"这个数字
- **不知道**动销率 = 动销SKU数 / 总SKU数 × 100
- **不知道**动销SKU的定义（月售>0）

**后果**:
- AI无法推导为什么动销率低
- AI无法建议如何提升动销率（应该增加动销SKU数还是减少总SKU数？）
- AI可能给出脱离实际的建议

### 问题2: AI不知道"促销强度"是怎么计算的

**当前计算逻辑** (在collect_dashboard_data中):
```python
cat_info['促销强度'] = ((10 - discount_level) / 9 * 100) if discount_level < 10 else 0
```

**AI看到的**:
```json
{
    "分类": "饮料",
    "促销强度": 58.87,  # ← AI只看到这个数字
    "折扣力度": 4.70
}
```

**AI不知道**:
- 促销强度 = (10 - 折扣力度) / 9 × 100
- 折扣力度越低，促销强度越高（反比关系）
- 促销强度>50%意味着什么

**后果**:
- AI可能说"促销强度58.87%偏低"（实际上这已经很高了！）
- AI无法理解促销强度和折扣力度的关系

### 问题3: 字段名不友好

**当前字段名**:
```
'美团一级分类去重SKU数(口径同动销率)'
'美团一级分类动销率(类内)'
```

**AI的理解困难**:
- 这些字段名太长、太专业
- "(口径同动销率)"是什么意思？
- "动销率(类内)"和"动销率(跨类)"的区别？

---

## 💡 解决方案

### 方案A: 在Prompt中注入计算逻辑（推荐，快速实施）

在每个Analyzer的`_build_xxx_prompt()`中添加**指标说明**：

```python
def _build_kpi_prompt(self, kpi_data: Dict) -> str:
    prompt = f"""
你是资深零售数据分析专家。

【核心指标定义】
- **动销率** = 动销SKU数 / 总SKU数 × 100
  * 动销SKU: 月售 > 0 的商品
  * 行业标准: 60-80%为健康，<60%需优化
  
- **滞销率** = 滞销SKU数 / 总SKU数 × 100
  * 滞销SKU: 月售 = 0 的商品
  * 动销率 + 滞销率 = 100%
  
- **爆品占比** = 爆品SKU数 / 总SKU数 × 100
  * 爆品定义: 月售排名TOP20%的商品
  
- **平均折扣** = 折扣力度的平均值
  * 10折 = 无折扣
  * 数值越小，折扣越大

【当前数据】
{json.dumps(kpi_data, ensure_ascii=False, indent=2)}

【分析要求】
基于以上指标定义，分析当前门店的健康度...
"""
```

**优点**:
- ✅ 快速实施，只需修改Prompt
- ✅ AI能理解每个指标的含义和计算逻辑
- ✅ AI能给出基于逻辑的建议

**缺点**:
- ⚠️ Prompt会变长（但仍在token限制内）

### 方案B: 传递原始数据+计算逻辑（更彻底，但复杂）

修改`collect_dashboard_data()`，同时传递：
1. 计算好的指标
2. 原始数据（用于验证）
3. 计算公式

```python
def collect_dashboard_data(selected_categories=None):
    return {
        'kpi': {
            # 计算好的指标
            'indicators': {
                '动销率': 45.52,
                '总SKU数': 8527,
                '动销SKU数': 3250,
            },
            # 原始数据（用于AI验证）
            'raw': {
                '所有SKU': [...],  # SKU列表
                '月售数据': [...]
            },
            # 计算公式
            'formulas': {
                '动销率': '动销SKU数 / 总SKU数 × 100'
            }
        }
    }
```

**优点**:
- ✅ AI可以验证计算正确性
- ✅ AI可以深度分析（比如找出哪些SKU拖累动销率）

**缺点**:
- ❌ 数据量大，token消耗高
- ❌ 实施复杂

### 方案C: 使用业务知识库（长期方案）

已有的`ai_business_context.py`可以扩展：

```python
# ai_business_context.py
def get_kpi_definitions():
    return {
        '动销率': {
            'definition': '有销量的商品占总商品的比例',
            'formula': '动销SKU数 / 总SKU数 × 100',
            'unit': '%',
            'benchmark': {
                '优秀': '>= 80%',
                '健康': '60-80%',
                '预警': '40-60%',
                '危险': '< 40%'
            },
            'optimization': [
                '下架长期滞销商品',
                '引入热销品类',
                '优化促销策略'
            ]
        }
    }
```

然后在Prompt中引用：
```python
kpi_defs = get_kpi_definitions()
prompt = f"""
【指标定义】
{json.dumps(kpi_defs, ensure_ascii=False, indent=2)}

【当前数据】
{kpi_data}
"""
```

---

## 📝 推荐行动方案

### 立即实施（本次迭代）

**修改所有Analyzer的Prompt，注入指标定义**

#### 1. KPI Panel - 添加指标说明
```python
def _build_kpi_prompt(self, kpi_data: Dict) -> str:
    prompt = f"""
【核心指标定义与计算逻辑】

1. **SKU相关**
   - 总SKU数(含规格): 包含所有单规格+多规格商品的SKU总数
   - 去重SKU数: 同一商品的不同规格只算1个
   - 多规格SKU: 同一商品有多个规格(如可乐300ml/500ml)

2. **动销指标**
   - 动销SKU数: 月售 > 0 的SKU数量
   - 滞销SKU数: 月售 = 0 的SKU数量
   - 动销率 = 动销SKU数 / 去重SKU数 × 100
   - 行业基准: 60-80%健康，<60%需优化

3. **销售指标**
   - 总销售额(去重后): 所有SKU的售价×月售之和
   - 平均售价: 总销售额 / 总销量
   - 客单价: 总销售额 / 订单数

4. **促销指标**
   - 平均折扣: 所有SKU的折扣力度平均值
   - 10折 = 无折扣，数值越小折扣越大
   - 健康范围: 9.0-9.5折（适度促销）

【当前KPI数据】
{json.dumps(kpi_data, ensure_ascii=False, indent=2)}

【分析任务】
基于以上定义，逐项分析每个KPI的健康度...
"""
```

#### 2. Category Panel - 添加分类指标说明
```python
def _build_category_prompt(self, category_data: List[Dict]) -> str:
    prompt = f"""
【分类指标定义】

1. **销售额**: 该分类所有SKU的售价×月售之和
2. **动销率(类内)**: 该分类内动销SKU数 / 该分类总SKU数 × 100
   - 只看该分类内部的动销情况
3. **折扣力度**: 该分类的平均折扣
   - 数值越小，折扣越大，促销越激进
4. **促销强度**: (10 - 折扣力度) / 9 × 100
   - 0% = 无促销，100% = 全面促销
   - >50% 属于强促销

【当前分类数据】（已按销售额降序）
{json.dumps(category_data, ensure_ascii=False, indent=2)}

【分析任务】
1. TOP3分类集中度是否过高？
2. 哪些分类动销率低但促销力度也低？（改进机会）
3. 哪些分类过度促销？（利润风险）
"""
```

### 中期优化（下个迭代）

1. **扩展`ai_business_context.py`**
   - 添加完整的指标定义库
   - 添加行业benchmark
   - 添加优化建议模板

2. **添加数据验证层**
   - 在Panel AI分析前验证数据合理性
   - 检测异常值（如动销率>100%）

### 长期规划

1. **向量检索增强**
   - 将指标定义存入向量库
   - AI分析时自动检索相关定义

2. **交互式解释**
   - 用户点击指标时显示定义
   - AI分析结果中可展开查看计算逻辑

---

## 🎯 总结

### 当前状态
- ✅ **数据源一致**: Panel AI和看板使用同一数据
- ✅ **已处理数据**: 传递的是计算好的指标
- ❌ **缺少上下文**: AI不知道指标的计算逻辑
- ❌ **字段名复杂**: AI理解困难

### 核心问题
**AI是"黑盒分析"** - 只看到数字，不知道数字背后的含义和计算逻辑！

### 推荐方案
**立即在Prompt中注入指标定义和计算逻辑**（方案A）

---

**需要我立即实施这个优化吗？我可以：**
1. 修改所有Analyzer的`_build_xxx_prompt()`方法
2. 添加完整的指标定义和计算逻辑
3. 添加行业benchmark和健康度标准
4. 确保AI能给出基于逻辑的、可执行的建议
