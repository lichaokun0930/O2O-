# Dashboard列索引错误修复报告 v1.0

## 🎯 修复概述

**修复日期**: 2025年
**修复范围**: dashboard_v2.py
**修复数量**: 11个列索引错误
**根本原因**: Excel报告结构调整后，硬编码的列索引未同步更新

---

## 📊 关键列索引映射表

| Excel列 | 索引 | 列名 | 数据类型 | 常见错误 |
|---------|------|------|----------|----------|
| **I** | 8 | 活动去重SKU数 | 整数 | ⚠️ 等于E列（去重SKU数），不能用于计算非活动数 |
| **J** | 9 | 活动SKU数 | 整数 | ✅ 正确的活动商品数量 |
| **W** | 22 | 售价销售额占比 | 0-1小数 | ⚠️ 经常被误认为折扣SKU数 |
| **Y** | 24 | 毛利贡献度 | 0-1小数 | ⚠️ 经常被误认为平均折扣 |
| **AA** | 26 | 折扣SKU数 | 整数 | ✅ 正确的折扣商品数量 |
| **AC** | 28 | 折扣 | 7-10折 | ✅ 正确的平均折扣值 |

---

## 🐛 Bug修复明细

### Bug #1 - 一级分类Sheet读取错误
- **位置**: 第75-105行（`load_data_from_excel`方法）
- **问题**: 使用固定索引`sheet_names[3]`读取Sheet，当有校验Sheet时索引错位
- **症状**: 读取到错误的Sheet，显示无数据或错误数据
- **修复**: 改为遍历`sheet_names`，按名称匹配"一级分类详细指标"
- **验证**: ✅ 正确显示38个分类（个人洗护、休闲食品等）

---

### Bug #2 - 促销效能非活动SKU计算错误
- **位置**: 第2397行（`create_promotional_effectiveness`函数）
- **错误代码**: 
  ```python
  非活动sku数 = dedup_sku数 - pd.to_numeric(df.iloc[:, 8], errors='coerce').fillna(0)
  ```
- **问题**: 索引8是"活动去重SKU数"，等于E列（去重SKU数），导致E-I=0
- **数据实例**: 个人洗护 E列2096 - I列2096 = 0（错误）
- **修复**: 改用索引9（活动SKU数）
  ```python
  非活动sku数 = dedup_sku数 - pd.to_numeric(df.iloc[:, 9], errors='coerce').fillna(0)
  ```
- **验证**: ✅ 个人洗护 2096 - 1812 = 284个非活动SKU

---

### Bug #3 - 促销效能平均折扣显示错误
- **位置**: 第2378行（`create_promotional_effectiveness`函数）
- **错误代码**: 
  ```python
  discount_level = pd.to_numeric(df.iloc[:, 24], errors='coerce').fillna(0)
  ```
- **问题**: 索引24是"毛利贡献度"（0-1小数），不是折扣
- **数据实例**: 显示0.45折，实际应该是7.89折
- **修复**: 改用索引28（折扣）
  ```python
  discount_level = pd.to_numeric(df.iloc[:, 28], errors='coerce').fillna(0)
  ```
- **验证**: ✅ 个人洗护7.89折、乳品/冰品8.68折

---

### Bug #4 - 折扣商品供给SKU数量全为0
- **位置**: 第1226行（`create_discount_analysis`函数）
- **错误代码**: 
  ```python
  discount_sku_col = category_data.iloc[:, 22]
  ```
- **问题**: 索引22是"售价销售额占比"（0-1小数），不是折扣SKU数
- **数据实例**: 显示0.54个，实际应该是1812个
- **修复**: 改用索引26（折扣SKU数）
  ```python
  discount_sku_col = category_data.iloc[:, 26]
  ```
- **验证**: ✅ 个人洗护1812个、休闲食品562个

---

### Bug #5 - 折扣渗透率热力图SKU占比全为0
- **位置**: 第1424行（`create_discount_heatmap`函数）
- **错误代码**: 
  ```python
  discount_sku = category_data.iloc[:, 22]
  ```
- **问题**: 同Bug #4，使用了售价销售额占比
- **修复**: 改用索引26
  ```python
  discount_sku = category_data.iloc[:, 26]
  ```
- **验证**: ✅ 个人洗护83.5%、休闲食品86.3%

---

### Bug #6 - 销量销售额气泡图折扣SKU数错误
- **位置**: 第1703行（`create_sales_bubble_chart`函数）
- **错误代码**: 
  ```python
  discount_sku = category_data.iloc[:, 22]  # W列：折扣SKU数
  ```
- **问题**: 注释写的W列（索引22），实际应该是AA列（索引26）
- **修复**: 
  ```python
  discount_sku = category_data.iloc[:, 26]  # AA列：折扣SKU数
  ```
- **影响**: 气泡图颜色（折扣占比）计算错误
- **验证**: ✅ 颜色渐变正确反映折扣力度

---

### Bug #7 - KPI门店平均折扣计算错误
- **位置**: 第173行（`calculate_summary_metrics`方法）
- **错误代码**: 
  ```python
  discount_col = pd.to_numeric(category_df.iloc[:, 24], errors='coerce')
  summary['门店平均折扣'] = discount_col.mean()
  ```
- **问题**: 索引24是毛利贡献度，注释写的Y列也是错的
- **修复**: 改用索引28（AC列）
  ```python
  discount_col = pd.to_numeric(category_df.iloc[:, 28], errors='coerce')
  summary['门店平均折扣'] = discount_col.mean()
  ```
- **影响**: Dashboard首页KPI卡片显示错误折扣
- **验证**: ✅ 待重启Dashboard验证

---

### Bug #8 - KPI促销强度计算错误
- **位置**: 第210行（`calculate_summary_metrics`方法）
- **错误代码**: 
  ```python
  total_discount_skus = pd.to_numeric(category_df.iloc[:, 22], errors='coerce').sum()
  ```
- **问题**: 索引22是售价销售额占比，不是折扣SKU数
- **修复**: 改用索引26
  ```python
  total_discount_skus = pd.to_numeric(category_df.iloc[:, 26], errors='coerce').sum()
  ```
- **影响**: 促销强度 = 折扣商品数 / 动销SKU数 计算错误
- **验证**: ✅ 待重启Dashboard验证

---

### Bug #9 - 折扣分析洞察计算错误
- **位置**: 第1353行（`generate_discount_insights`函数）
- **错误代码**: 
  ```python
  discount_sku = category_data_copy.iloc[:, 22]  # W列：折扣SKU
  ```
- **问题**: 同样的索引22错误
- **修复**: 改用索引26
  ```python
  discount_sku = category_data_copy.iloc[:, 26]  # AA列：折扣SKU
  ```
- **影响**: 折扣占比、效率分析等洞察全部错误
- **验证**: ✅ 待验证洞察内容

---

### Bug #10 - 热力图洞察计算错误
- **位置**: 第1514行（`generate_heatmap_insights`函数）
- **错误代码**: 
  ```python
  discount_sku = category_data.iloc[:, 22]
  discount_sku_ratio = (discount_sku / total_sku * 100).fillna(0)
  ```
- **问题**: 又是索引22错误
- **修复**: 改用索引26
  ```python
  discount_sku = category_data.iloc[:, 26]
  ```
- **影响**: 高/中/低渗透品类识别错误
- **验证**: ✅ 待验证洞察内容

---

### Bug #11 - 促销效能洞察活动SKU数错误
- **位置**: 第2620行（`generate_promotional_insights`函数）
- **错误代码**: 
  ```python
  '活动SKU数': pd.to_numeric(df.iloc[:, 8], errors='coerce').fillna(0),
  ```
- **问题**: 索引8是活动去重SKU数，等于总SKU数
- **修复**: 改用索引9（活动SKU数）
  ```python
  '活动SKU数': pd.to_numeric(df.iloc[:, 9], errors='coerce').fillna(0),  # J列：活动SKU数
  ```
- **影响**: 促销渗透率、促销不均衡分析全部错误
- **验证**: ✅ 待重启Dashboard验证

---

### Bug #12 - KPI门店爆品数显示小数 ⭐ 新发现
- **位置**: 第167行（`calculate_summary_metrics`方法）
- **错误代码**: 
  ```python
  summary['门店爆品数'] = category_df.iloc[:, 23].sum()
  ```
- **问题**: 索引23是"毛利率"（0-1小数），不是爆品SKU数
- **数据实例**: 显示13.545649...（这是毛利率的求和）
- **修复**: 改用索引27（爆品SKU数）
  ```python
  summary['门店爆品数'] = category_df.iloc[:, 27].sum()  # AB列：爆品SKU数
  ```
- **验证**: ✅ 爆品数应为72个（整数）

---

### Bug #13 - KPI促销强度计算逻辑错误 ⭐ 新发现
- **位置**: 第206-212行（`calculate_summary_metrics`方法）
- **错误代码**: 
  ```python
  total_discount_skus = pd.to_numeric(category_df.iloc[:, 26], errors='coerce').sum()
  active_skus = summary['动销SKU数']  # 3336
  summary['促销强度'] = (total_discount_skus / active_skus)
  ```
- **问题**: 
  1. 使用"动销SKU数"(3336)做分母
  2. 折扣SKU数(6605) > 动销SKU数(3336)，导致促销强度 = 198%（不可能）
  3. 正确逻辑：促销强度 = 折扣商品数 / **活动SKU数**
- **数据验证**:
  - 活动SKU数(索引9) = 6605
  - 折扣SKU数(索引26) = 6605
  - 正确促销强度 = 6605 / 6605 = 100%
- **修复**: 改用活动SKU数做分母
  ```python
  total_discount_skus = pd.to_numeric(category_df.iloc[:, 26], errors='coerce').sum()
  total_activity_skus = pd.to_numeric(category_df.iloc[:, 9], errors='coerce').sum()
  summary['促销强度'] = (total_discount_skus / total_activity_skus)
  ```
- **验证**: ✅ 促销强度应为100%（在本数据中所有活动商品都是折扣商品）

---

## 🔍 根因分析

### 系统性问题模式

1. **列索引硬编码**: 使用`iloc[:, 22]`这种硬编码索引，Excel结构变化时未同步更新
2. **注释与代码不一致**: 
   - 注释写"W列"，实际索引却是22（W列应该是索引22，但折扣SKU在AA列索引26）
   - 注释写"Y列"，索引24，但折扣在AC列索引28
   - 注释写"X列"，索引23，但爆品在AB列索引27
3. **缺乏列名验证**: 没有在运行时验证列名，导致读取错误列也不会报错
4. **重复犯错**: 
   - 索引22被错误使用了**7次**（Bug 4-10）
   - 索引8被错误使用了**3次**（Bug 2、11）
   - 索引23、24被错误使用了**各2次**
5. **计算逻辑错误**: Bug #13不仅是列索引问题，更是业务逻辑问题（分母选择错误）

### 建议改进措施

#### 1. 使用列名而非索引（最优方案）
```python
# ❌ 不推荐：硬编码索引
discount_sku = category_data.iloc[:, 22]

# ✅ 推荐：使用列名
discount_sku = category_data['美团一级分类折扣sku数']
```

#### 2. 创建列索引映射常量
```python
# dashboard_v2.py 顶部定义
CATEGORY_COLUMNS = {
    '一级分类': 0,
    '总SKU数': 1,
    '去重SKU数': 4,
    '活动SKU数': 9,  # 注意：不是8！
    '售价销售额': 18,
    '售价销售额占比': 22,
    '折扣SKU数': 26,  # 注意：不是22！
    '折扣': 28,  # 注意：不是24！
}

# 使用时
discount_sku = category_data.iloc[:, CATEGORY_COLUMNS['折扣SKU数']]
```

#### 3. 添加运行时校验
```python
def validate_columns(df, required_columns):
    """验证DataFrame包含所需列"""
    missing = set(required_columns) - set(df.columns)
    if missing:
        raise ValueError(f"缺少必需列: {missing}")
```

---

## ✅ 验证清单

### 重启Dashboard后需验证的看板：

- [ ] **首页KPI卡片（Bug 7、8、12、13）** ⭐ 重点
  - [ ] 门店平均折扣：应为7.6折
  - [ ] 促销强度：应为100%（之前错误显示198%）
  - [ ] **门店爆品数：应为72个**（之前错误显示13.545...）
  - [ ] 其他KPI值正常显示

- [ ] 促销效能分析（Bug 2、3、11）
  - [ ] 非活动SKU数：个人洗护应为284个
  - [ ] 平均折扣：个人洗护7.89折、乳品/冰品8.68折
  - [ ] AI洞察：促销渗透率、促销不均衡分析

- [ ] 折扣商品供给分析（Bug 4）
  - [ ] 折扣SKU数量：个人洗护1812个、休闲食品562个

- [ ] 折扣渗透率热力图（Bug 5、10）
  - [ ] 折扣SKU占比：个人洗护83.5%、休闲食品86.3%
  - [ ] AI洞察：高/中/低渗透品类识别

- [ ] 分类销量与销售额对比（Bug 6）
  - [ ] 气泡图颜色：应该反映折扣力度（红=高折扣，绿=低折扣）
  - [ ] hover信息：折扣SKU数和折扣占比应合理

- [ ] 折扣商品分析（Bug 9）
  - [ ] AI洞察：高折扣占比品类、折扣效率分析

---

## 📝 文件修改记录

- **文件**: `d:\Python1\O2O_Analysis\O2O数据分析\门店基础数据分析\dashboard_v2.py`
- **总行数**: 6804行
- **修改位置**: 
  - 第75-105行（Sheet读取逻辑，1处）
  - 第167行（门店爆品数，1处） ⭐ 新增
  - 第173行（门店平均折扣，1处）
  - 第206-212行（促销强度计算逻辑，1处） ⭐ 新增
  - 第1226行（折扣商品供给，1处）
  - 第1353行（折扣分析洞察，1处）
  - 第1424行（折扣渗透率热力图，1处）
  - 第1514行（热力图洞察，1处）
  - 第1703行（销量销售额气泡图，1处）
  - 第2378行（促销效能平均折扣，1处）
  - 第2397行（促销效能非活动SKU，1处）
  - 第2620行（促销效能洞察，1处）
- **总计**: **13处修复**
- **语法验证**: ✅ 已通过`py_compile`检查

---

## 🎓 经验教训

1. **数据结构变更风险**: Excel报告结构调整后，所有硬编码索引都需要审查更新
2. **注释可能误导**: 代码注释可能过时，应以实际验证为准
3. **系统性测试重要性**: 一个列索引错误可能在多个地方重复出现
4. **数据验证必要性**: 应该在开发时就验证读取的数据是否合理（如折扣应为7-10，SKU数应为正整数）

---

## 🚀 后续行动

1. ✅ 完成13个Bug修复
2. ⏳ 重启Dashboard验证所有修复
3. ⏳ 考虑重构为列名访问模式
4. ⏳ 添加自动化测试，防止类似问题再次发生
5. ⏳ 更新开发文档，记录正确的列索引映射

---

**报告生成时间**: 2025年10月29日  
**报告作者**: GitHub Copilot  
**审核状态**: 待用户验证  
**修复版本**: v1.1（新增Bug #12、#13）
