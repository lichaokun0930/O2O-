# 促销效能分析问题修复方案

## 问题总结

### 1. 促销强度计算公式错误
**当前公式**:
```python
promo_intensity = ((10 - discount_level) / 9 * 100)
```

**问题**: 
- 分母是9,导致1折=100%促销强度,0折=111%促销强度(被clip到100%)
- 这不符合促销强度的定义

**正确公式**:
```python
# 促销强度 = 折扣力度 = (10折 - 实际折扣) / 10 * 100%
promo_intensity = ((10 - discount_level) / 10 * 100)
# 例如: 6折 = (10-6)/10*100 = 40%促销强度
# 例如: 0折(免费) = (10-0)/10*100 = 100%促销强度
```

### 2. 数据异常处理
**当前**: `fillna(10)` - 缺失值填充为10折(无折扣)

**问题**: 5个分类的折扣值是0.0,导致100%促销强度

**建议**: 
1. 使用中位数或平均值填充异常值(0和10)
2. 或者使用活动占比作为促销强度指标(更准确)

### 3. 替代方案: 使用活动占比

**优势**:
- 直接反映参与促销的商品比例
- 数据质量更可靠(1.0%平均值合理)
- 与业务定义一致

**实现**:
```python
# 使用K列(美团一级分类活动SKU占比类内)作为促销强度
promo_intensity = pd.to_numeric(df.iloc[:, 10], errors='coerce').fillna(0)
```

## 修复代码

### 方案A: 修正折扣计算公式
```python
# Line 2303-2306
# 计算折扣力度作为促销强度指标
discount_level = pd.to_numeric(df.iloc[:, 24], errors='coerce')

# 处理异常值: 0折和10折都是异常,用中位数替换
median_discount = discount_level[discount_level > 0].median()
discount_level = discount_level.replace(0, median_discount).fillna(median_discount)

# 正确的促销强度公式: (10 - 实际折扣) / 10 * 100
promo_intensity = ((10 - discount_level) / 10 * 100).clip(lower=0, upper=100)
```

### 方案B: 使用活动占比(推荐)
```python
# Line 2303-2306
# 使用活动占比作为促销强度 (更直观,更准确)
activity_ratio_类内 = pd.to_numeric(df.iloc[:, 10], errors='coerce').fillna(0)  # K列
promo_intensity = activity_ratio_类内  # 直接使用活动占比%

# 保留折扣力度用于展示
discount_level = pd.to_numeric(df.iloc[:, 24], errors='coerce').fillna(10)
```

## 图表标题更新

如果采用方案B,需要更新图表标题和说明:

```python
# 气泡图标题
title='<b>促销效能分析</b><br><sub>X轴=活动商品占比% | Y轴=销售额 | 气泡=月售量</sub>'

# 柱状图标题  
title='<b>活动商品占比TOP10分类</b><br><sub>活动商品占比 = 活动SKU数 / 去重SKU数</sub>'

# 颜色说明
# 红色(>60% 活动占比) = 高促销强度
# 橙色(40-60%) = 中等促销强度  
# 绿色(<40%) = 低促销强度
```

## 测试验证

修改后需要验证:
1. ✅ 气泡图数据分布更合理(不全集中在0%附近)
2. ✅ TOP10柱状图不再有异常的100%数据
3. ✅ 标签重叠问题需要调整textposition或增加repel逻辑

## 实施优先级

**P0 (立即修复)**:
- 修正促销强度计算公式或改用活动占比
- 处理0折异常数据

**P1 (重要)**:
- 更新图表标题和说明文字
- 优化标签显示逻辑

**P2 (优化)**:
- 添加数据质量检查
- 增加hover信息的详细程度
