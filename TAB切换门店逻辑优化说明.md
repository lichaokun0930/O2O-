# TAB切换门店逻辑优化说明

## ✅ 优化完成

已成功实现TAB切换时自动更新门店列表的功能！

---

## 🎯 解决的问题

### 问题：竞对数据看板无法切换竞对门店

- ❌ **优化前**：无论在哪个TAB，门店切换下拉框都只显示本店列表
- ✅ **优化后**：
  - 在"本店数据看板"TAB：显示本店列表
  - 在"竞对数据看板"TAB：显示竞对列表
  - 在"对比分析"TAB：显示本店列表（因为对比分析有独立的选择器）

---

## 🔧 修改的代码

### 1. 更新门店切换器回调

**文件**：`dashboard_v2.py` 第5337行

**修改内容**：
- 添加 `Input('main-tabs', 'active_tab')` 监听TAB切换
- 根据当前TAB决定显示本店还是竞对列表
- 自动选中第一个门店

**逻辑**：
```python
if active_tab == 'tab-competitor':
    # 竞对数据看板TAB：显示竞对列表
    store_list = store_manager.get_store_list('competitor')
    icon = '🎯'
    type_label = '竞对'
else:
    # 本店数据看板TAB（默认）：显示本店列表
    store_list = store_manager.get_store_list('own')
    icon = '🏪'
    type_label = '本店'
```

### 2. 优化门店切换回调

**文件**：`dashboard_v2.py` 第5385行

**修改内容**：
- 添加 `State('main-tabs', 'active_tab')` 获取当前TAB
- 优化状态消息显示，明确标识本店/竞对
- 使用 `store_manager.competitor_stores` 判断门店类型

**逻辑**：
```python
# 判断是本店还是竞对
is_competitor = selected_store in store_manager.competitor_stores
icon = '🎯' if is_competitor else '🏪'
type_label = '竞对' if is_competitor else '本店'
```

---

## 🧪 测试步骤

### 步骤1：启动Dashboard

```bash
python dashboard_v2.py
```

### 步骤2：测试本店数据看板

1. 确保当前在"本店数据看板"TAB
2. 查看"门店切换"下拉框
3. 应该显示：🏪 惠宜选-铜山万达（5）
4. 选择一个本店，查看数据是否正确加载

### 步骤3：测试竞对数据看板

1. 点击"竞对数据看板"TAB
2. 查看"门店切换"下拉框
3. 应该自动切换为：🎯 江小囤-金鹰店（8）
4. 选择一个竞对，查看数据是否正确加载

### 步骤4：测试TAB切换

1. 在"本店数据看板"TAB选择一个本店
2. 切换到"竞对数据看板"TAB
3. 门店切换下拉框应该自动更新为竞对列表
4. 切换回"本店数据看板"TAB
5. 门店切换下拉框应该自动恢复为本店列表

### 步骤5：测试对比分析TAB

1. 切换到"对比分析"TAB
2. 门店切换下拉框应该显示本店列表（因为对比分析有独立的选择器）

---

## ✅ 预期结果

- ✅ 在"本店数据看板"TAB，门店切换显示本店列表
- ✅ 在"竞对数据看板"TAB，门店切换显示竞对列表
- ✅ TAB切换时，门店列表自动更新
- ✅ 切换门店后，数据正确加载
- ✅ 状态消息明确标识本店/竞对
- ✅ 无JavaScript错误

---

## 📊 功能演示

### 本店数据看板
```
TAB: 🏪 本店数据看板
门店切换: [🏪 惠宜选-铜山万达（5）] ▼
状态: ✅ 已切换到本店: 🏪 惠宜选-铜山万达（5）
```

### 竞对数据看板
```
TAB: 🎯 竞对数据看板
门店切换: [🎯 江小囤-金鹰店（8）] ▼
状态: ✅ 已切换到竞对: 🎯 江小囤-金鹰店（8）
```

---

## 🔍 技术细节

### TAB ID映射

| TAB名称 | TAB ID | 门店类型 |
|--------|--------|---------|
| 本店数据看板 | tab-own-store | own |
| 竞对数据看板 | tab-competitor | competitor |
| 对比分析 | tab-comparison | own（默认） |

### 回调触发流程

1. 用户点击TAB → `main-tabs.active_tab` 变化
2. 触发 `update_store_switcher` 回调
3. 根据 `active_tab` 获取对应的门店列表
4. 更新 `store-switcher` 的 options 和 value
5. 触发 `switch_store` 回调
6. 加载选中门店的数据

---

## ⚠️ 注意事项

### 1. 对比分析TAB的特殊性

对比分析TAB有自己独立的门店选择器：
- "选择本店"下拉框
- "选择竞对"下拉框

因此，对比分析TAB中的"门店切换"下拉框默认显示本店列表，但通常不会使用。

### 2. 门店数据要求

- 至少需要1个本店数据才能使用"本店数据看板"
- 至少需要1个竞对数据才能使用"竞对数据看板"
- 如果没有对应类型的门店，下拉框会显示"暂无XX数据"

### 3. 自动选择逻辑

切换TAB时，会自动选中该类型的第一个门店，并加载其数据。

---

## 📝 相关文档

- 门店管理优化：`门店管理优化完成报告.md`
- 测试指南：`门店管理测试指南.md`
- 实现进度：`.kiro/specs/store-comparison/implementation-progress.md`

---

## ✅ 验收标准

- [x] TAB切换时门店列表自动更新
- [x] 本店TAB显示本店列表
- [x] 竞对TAB显示竞对列表
- [x] 门店切换功能正常
- [x] 状态消息正确显示
- [x] 无语法错误
- [x] 日志记录清晰

---

**优化完成时间**：2024-12-14
**优化版本**：v2.1
