# 门店管理优化说明 v2.0

## 🎯 优化目标

解决对比分析功能无法使用的问题：
1. ✅ Dashboard刷新后门店列表丢失
2. ✅ 本店和竞对门店混在一起，无法区分
3. ✅ "门店切换"和"选择竞对"下拉框显示相同内容

## ✅ 已实现的优化

### 1. 分目录管理门店报告

**目录结构**：
```
reports/
├── 本店/
│   ├── 惠宜选-铜山万达_分析报告.xlsx
│   └── 另一个本店_分析报告.xlsx
└── 竞对门店/
    ├── 江小囤-金鹰店_分析报告.xlsx
    └── 另一个竞对_分析报告.xlsx
```

**规则**：
- 本店报告保存在 `reports/本店/`
- 竞对报告保存在 `reports/竞对门店/`
- 自动创建目录（如果不存在）

### 2. 自动发现门店报告

**功能**：Dashboard启动时自动扫描两个目录，分别加载本店和竞对门店。

**实现位置**：`dashboard_v2.py` - `StoreManager.auto_discover_stores()`方法

**支持的文件格式**：
- `门店名称_分析报告.xlsx`（统一格式）

**自动识别规则**：
1. `reports/本店/` 目录下的文件 → 识别为本店
2. `reports/竞对门店/` 目录下的文件 → 识别为竞对
3. 不再需要文件名前缀来区分

**排除规则**：
- 临时文件（以`~$`开头）
- 带时间戳的备份文件（包含`_202`）
- 示例门店

### 3. 分别管理本店和竞对列表

**数据结构**：
```python
store_manager.own_stores = {
    "惠宜选-铜山万达": "reports/本店/惠宜选-铜山万达_分析报告.xlsx"
}

store_manager.competitor_stores = {
    "江小囤-金鹰店": "reports/竞对门店/江小囤-金鹰店_分析报告.xlsx"
}
```

### 4. 下拉框分别显示

**门店切换下拉框**：
- 只显示 `own_stores` 中的本店
- 用于切换当前查看的本店数据

**选择竞对下拉框**：
- 只显示 `competitor_stores` 中的竞对
- 用于对比分析时选择竞对

### 5. 自动设置默认门店

**逻辑**：
1. 自动选择第一个本店作为默认门店
2. 自动加载默认门店的数据

### 6. 详细的日志记录

**日志输出示例**：
```
🔍 开始自动发现门店报告...
  ✅ 发现本店: 惠宜选-铜山万达
  ✅ 发现竞对: 江小囤-金鹰店
📍 默认门店设置为: 惠宜选-铜山万达
🎉 自动发现完成: 本店 1 个, 竞对 1 个
```

---

## 📋 使用流程

### 完整流程（从零开始）

#### 步骤1：上传本店原始数据
1. 打开Dashboard
2. 点击"上传原始数据"
3. 选择本店的CSV/Excel文件
4. 输入门店名称（如：惠宜选-铜山万达）
5. 点击"运行分析"
6. 等待分析完成，生成报告：`reports/本店/惠宜选-铜山万达_分析报告.xlsx`

#### 步骤2：上传竞对原始数据
1. 点击"上传竞对数据"
2. 选择竞对的CSV/Excel文件
3. 输入竞对名称（如：江小囤-金鹰店）
4. 点击"运行分析"
5. 等待分析完成，生成报告：`reports/竞对门店/江小囤-金鹰店_分析报告.xlsx`

#### 步骤3：刷新页面（或重启Dashboard）
1. 刷新浏览器页面（F5）
2. Dashboard自动扫描`reports/`目录
3. 自动发现并加载所有门店

#### 步骤4：使用对比分析功能
1. 在"门店切换"下拉框中，只显示本店：
   - 🏪 惠宜选-铜山万达
2. 开启"对比模式"开关
3. 在"选择竞对"下拉框中，只显示竞对：
   - 🎯 江小囤-金鹰店
4. 选择竞对后，查看对比分析结果

---

## 🔍 新的目录结构

优化后的目录结构：

```
reports/
├── 本店/
│   └── 惠宜选-铜山万达_分析报告.xlsx          ✅ 本店
├── 竞对门店/
│   └── 江小囤-金鹰店_分析报告.xlsx           ✅ 竞对
├── 示例门店_分析报告.xlsx                    ❌ 排除（旧文件）
└── README.md                                ❌ 排除（非报告文件）
```

**识别结果**：
- 本店：惠宜选-铜山万达
- 竞对：江小囤-金鹰店

**注意**：旧的报告文件（在reports根目录下）不会被自动识别，需要手动移动到对应目录。

---

## 🧪 测试步骤

### 测试1：验证自动发现功能

1. **启动Dashboard**
   ```bash
   python dashboard_v2.py
   ```

2. **查看Console日志**
   应该看到类似输出：
   ```
   🔍 开始自动发现门店报告，共找到 2 个文件
     ✅ 发现门店: 惠宜选-铜山万达（5）
     ✅ 发现门店: [竞对]江小囤-金鹰店（8）
   📍 默认门店设置为: 惠宜选-铜山万达（5）
   🎉 自动发现完成，共加载 2 个门店
   ```

3. **检查门店切换下拉框**
   - 应该显示2个门店
   - 默认选中：惠宜选-铜山万达（5）

### 测试2：验证对比模式功能

1. **开启对比模式**
   - 点击"对比模式"开关
   - 开关标签变为"ON"
   - "选择竞对"下拉框启用

2. **选择竞对门店**
   - 下拉框应显示：🎯 江小囤-金鹰店（8）
   - 选择该竞对
   - 查看Console日志，确认数据加载成功

3. **验证数据加载**
   - 打开浏览器开发者工具（F12）
   - 查看Console，应该看到：
     ```
     🔍 开始加载竞对数据: [竞对]江小囤-金鹰店（8）
     ✅ 竞对数据加载成功: [竞对]江小囤-金鹰店（8）
     📊 KPI数据: X 项
     📊 分类数据: X 条
     ```

### 测试3：验证刷新后的持久化

1. **刷新页面**（F5）
2. **检查门店列表**
   - 门店切换下拉框应该仍然显示2个门店
   - 对比模式开关应该恢复为OFF
3. **再次开启对比模式**
   - 应该能够正常选择竞对门店

---

## ⚠️ 注意事项

### 1. 文件命名规范

为了确保自动识别正确，建议遵循以下命名规范：

**本店报告**：
- `门店名称_分析报告.xlsx`
- 例如：`惠宜选-铜山万达_分析报告.xlsx`

**竞对报告**：
- `竞对分析_门店名称.xlsx`
- 或：`[竞对]门店名称_分析报告.xlsx`
- 例如：`竞对分析_江小囤-金鹰店.xlsx`

### 2. 避免重复文件

- 不要在reports目录下保留带时间戳的备份文件
- 如果需要备份，请移动到其他目录

### 3. 示例门店

- 示例门店会被自动排除，不会出现在门店列表中

---

## 🐛 常见问题

### Q1：刷新后门店列表为空？

**可能原因**：
- reports目录下没有符合格式的报告文件
- 所有文件都被排除（示例门店、带时间戳等）

**解决方法**：
1. 检查reports目录下是否有`*_分析报告.xlsx`文件
2. 查看Console日志，确认扫描结果
3. 确保文件名符合命名规范

### Q2：竞对门店没有被识别？

**可能原因**：
- 文件名不符合竞对格式

**解决方法**：
1. 确保文件名包含"竞对"关键词
2. 或使用`竞对分析_门店名称.xlsx`格式
3. 或手动在文件名前添加`[竞对]`前缀

### Q3：对比模式下拉框为空？

**可能原因**：
- 只有1个门店（本店）
- 当前门店就是唯一的门店

**解决方法**：
1. 上传至少2个门店的数据
2. 确保至少有1个竞对门店

---

## 📊 技术细节

### 代码位置

**StoreManager类**：`dashboard_v2.py` 第370-470行

**关键方法**：
- `__init__()`: 初始化时调用`auto_discover_stores()`
- `auto_discover_stores()`: 扫描reports目录，自动加载门店
- `get_store_list()`: 获取所有门店列表
- `get_report_path()`: 获取门店报告路径

### 数据结构

```python
store_manager.stores = {
    "惠宜选-铜山万达（5）": "reports/惠宜选-铜山万达（5）_分析报告.xlsx",
    "[竞对]江小囤-金鹰店（8）": "reports/竞对分析_江小囤-金鹰店（8）.xlsx"
}

store_manager.current_store = "惠宜选-铜山万达（5）"
```

---

## ✅ 优化效果

### 优化前：
- ❌ 刷新页面后门店列表丢失
- ❌ 无法使用对比分析功能
- ❌ 需要重新上传数据

### 优化后：
- ✅ 刷新页面后自动恢复门店列表
- ✅ 对比分析功能正常使用
- ✅ 无需重新上传数据
- ✅ 支持多门店管理

---

## 🚀 下一步

优化完成后，可以继续实现：
1. **阶段2：核心卡片对比功能**
   - 核心指标概览对比
   - 一级分类动销分析对比
   - 多规格商品供给分析对比

2. **阶段3：差异分析引擎**
   - 自动生成差异分析洞察
   - 改进建议生成

请先测试当前的门店管理优化，确认功能正常后再继续！
